---
- name: Check if ca cert already exists
  stat:
    path: "{{ certdir }}/ca.pem"
  register: ca
- name: Generate config for ca
  copy:
    content: "{{ ca_config | to_json }}"
    dest: "{{ certdir }}/ca-config.json"
    mode: 0644
  when: not ca.stat.exists
- name: Generate csr for ca
  copy:
    content: "{{ ca_csr | to_json }}"
    dest: "{{ certdir }}/ca-csr.json"
    mode: 0644
  when: not ca.stat.exists
- name: Generate ca keys
  shell:
    cmd: |
        {{ cfssl_install_path }}/cfssl gencert -initca ca-csr.json | {{ cfssl_json_install_path }}/cfssljson -bare ca
  args:
    chdir: "{{ certdir }}"
  when: not ca.stat.exists
